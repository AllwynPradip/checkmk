#!/usr/bin/env bash

# Run this script e.g. to build the redis build
# ./scripts/run-bazel.sh build @redis//:build
#
# Check the check_mk/.bazelrc for available configs
#

set -e

ROOT_DIR="$(dirname "$(dirname "$(realpath "$0")")")"

if ! command -v bazelisk &>/dev/null; then
    cat <<EOF
bazelisk command not found in PATH. Please install bazelisk via:
https://github.com/bazelbuild/bazelisk?tab=readme-ov-file#installation

or use the installation script:
./buildscripts/infrastructure/build-nodes/scripts/install-development.sh --profile bazel --only
EOF
    exit 1
fi

ACTION="$1"
TARGET=("${@:2}")
TARGET_S1=$(echo "${TARGET[-1]}" | sed -e 's/\/\///g' -e 's/@//g' -e 's/:/_/g' -e 's/\//_/g')
EXECUTION_LOG_FILE_NAME="${ROOT_DIR}/bazel_execution_log-${TARGET_S1}.json"

echo "========================================================================="
echo "Environment variables taken into account by Bazel building \"$*\""
echo "  BAZEL_EXTRA_ARGS: $BAZEL_EXTRA_ARGS"
echo
echo "A file ${EXECUTION_LOG_FILE_NAME} will be generated by Bazel containing"
echo "information about caching"
echo "========================================================================="

# shellcheck disable=SC2086
bazel "${ACTION}" \
    --execution_log_json_file="${EXECUTION_LOG_FILE_NAME}" \
    ${BAZEL_EXTRA_ARGS} \
    "${TARGET[@]}"
