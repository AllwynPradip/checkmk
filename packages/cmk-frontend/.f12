#!/bin/bash
set -e

SITE=${SITE:-$(until [ "${PWD}" = / ]; do if [ -e .site ]; then
    cat .site
    break
else cd ..; fi; done)}
SITE=${SITE:-$(omd sites --bare | head -n 1)}
ROOT=/omd/sites/$SITE

./scripts/npm-ci
echo "Updating compiled JS/CSS files..."
npm run build
echo "Update site $SITE..."

echo "Copy files..."
sudo rsync -ax --delete \
    --filter "protect /js/vue_min.js*" \
    ./dist/ \
    "$ROOT/share/check_mk/web/htdocs"

if [ "$KILL_SITE_APACHE" = "1" ]; then
    echo "KILLING site apache of $SITE"
    sudo killall -9 -u "$SITE" apache2
fi

if [ -z "$ONLY_COPY" ]; then
    sudo omd reload "$SITE" apache
fi
