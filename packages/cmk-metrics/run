#!/bin/bash
# Copyright (C) 2022 Checkmk GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

set -e

failure() {
    test ${#@} -eq 0 || echo "$(basename "$0"):" "$@" >&2
    exit 1
}

usage() {
    echo "usage: $(basename "$0") [OPTION]..."
    echo "Run the CI pipeline or parts of it."
    echo
    echo "  -e, --setup-environment  setup environment"
    echo "  -f, --check-format       check for correct formatting (isort, black, flake8, autoflake)"
    echo "  -m, --mypy               run mypy"
    echo "  -p, --pylint             run pylint"
    echo "  -u, --unit-tests         run unit tests"
    echo "  -a, --all                shortcut for -f -m -p -u"
    echo "  -d, --documentation      generate documentation"
    echo "  -h, --help               show this help"
}

parse_options() {
    # Yes, all those option variables are global.
    RUN_SETUP_ENVIRONMENT=no
    RUN_CHECK_FORMAT=no
    RUN_MYPY=no
    RUN_PYLINT=no
    RUN_UNIT_TESTS=no
    RUN_DOCUMENTATION=no

    if ! OPTIONS=$(getopt --options 'efmpuadh' --long 'setup-environment,check-format,mypy,pylint,unit-tests,all,documentation,help' --name "$(basename "$0")" -- "$@"); then
        usage >&2
        failure
    fi
    eval set -- "$OPTIONS"
    unset OPTIONS

    while true; do
        case "$1" in
            '-e' | '--setup-environment')
                RUN_SETUP_ENVIRONMENT=yes
                shift
                continue
                ;;
            '-f' | '--check-format')
                RUN_CHECK_FORMAT=yes
                shift
                continue
                ;;
            '-m' | '--mypy')
                RUN_MYPY=yes
                shift
                continue
                ;;
            '-p' | '--pylint')
                RUN_PYLINT=yes
                shift
                continue
                ;;
            '-u' | '--unit-tests')
                RUN_UNIT_TESTS=yes
                shift
                continue
                ;;
            '-a' | '--all')
                RUN_CHECK_FORMAT=yes
                RUN_MYPY=yes
                RUN_PYLINT=yes
                RUN_UNIT_TESTS=yes
                shift
                continue
                ;;
            '-d' | '--documentation')
                RUN_DOCUMENTATION=yes
                shift
                continue
                ;;
            '-h' | '--help')
                usage
                exit 0
                ;;
            '--')
                shift
                test ${#@} -eq 0 || failure "extra arguments:" "$@"
                break
                ;;
            *) failure "internal error" ;;
        esac
    done

    readonly RUN_SETUP_ENVIRONMENT RUN_CHECK_FORMAT RUN_MYPY RUN_PYLINT RUN_UNIT_TESTS RUN_DOCUMENTATION
}

REPO_PATH="$(dirname -- "${BASH_SOURCE[0]}")"

run_pipenv() {
    # make sure we don't use "$HOME/.cache" accidentally (expands to /.cache, if HOME is not set)
    : "${PIPENV_CACHE_DIR:="${REPO_PATH}/.cache"}"
    export PIPENV_CACHE_DIR

    # Enforce a non localized environment. The reason for this configuration is
    # that the parameters and outputs of the monitoring plug-ins are localized. If
    # they are called from the core, they are always language-neutral. During
    # manual testing, the plugins may behave differently depending on the
    # localization of the user's environment variables. This can lead to confusion
    # during tests.
    if [ -z "$LANG" ]; then
        INSTALLED_LOCALES=$(locale -a)
        for i in "C.UTF-8" "C.utf8" "en_US.utf8" "C"; do
            if echo "$INSTALLED_LOCALES" | grep -q -w -F "$i"; then
                export LANG="$i" LC_ALL="$i"
                break
            fi
        done
    fi

    PIPENV_VENV_IN_PROJECT=true \
        PIPENV_NOSPIN=true \
        PIPENV_HIDE_EMOJIS=true \
        PIPENV_NO_INHERIT=true \
        PIPENV_PIPFILE="${REPO_PATH}"/Pipfile \
        PIPENV_IGNORE_VIRTUALENVS=1 \
        pipenv "$@"
}

run_check_format() {
    # shellcheck disable=SC2086
    run_pipenv run isort --settings-path "$REPO_PATH"/pyproject.toml $1

    # shellcheck disable=SC2086
    run_pipenv run black $1

    # shellcheck disable=SC2086
    run_pipenv run flake8 $1

    # shellcheck disable=SC2086
    run_pipenv run autoflake --remove-all-unused-imports -i $1
}

run_mypy() {
    # shellcheck disable=SC2086
    run_pipenv run mypy --scripts-are-modules --show-error-codes $1
}

run_pylint() {
    # shellcheck disable=SC2086
    run_pipenv run pylint $1
}

run_unit_tests() {
    run_pipenv run python -m pytest \
        --color=yes \
        --code-highlight=yes \
        "$REPO_PATH/tests/unit"
}

run_documentation() {
    echo "Run documentation"
}

get_candidates_from_filesystem() {
    cd "$REPO_PATH" || exit $?

    SEARCH="cmk_metrics tests"

    # Resolve search paths to real paths before the search for performance reasons
    # shellcheck disable=SC2086
    REAL_SEARCH=$(realpath $SEARCH)

    # shellcheck disable=SC2086
    find -L \
        $REAL_SEARCH \
        -name .mypy_cache -prune -o \
        -name .venv -prune -o \
        -type f -print0
}

filter_for_python_files() {
    sort --zero-terminated |
        xargs --no-run-if-empty --null \
            grep --binary-files=without-match --files-with-matches '^#!.*python3$'
}

main() {
    # Change to the directory where this script resides, it makes many things easier
    # and we can call this script from everywhere.
    cd -- "${BASH_SOURCE%/*}"
    parse_options "$@"

    test ${RUN_SETUP_ENVIRONMENT} = yes && run_pipenv sync --dev

    python_files=$(get_candidates_from_filesystem | filter_for_python_files)
    test ${RUN_CHECK_FORMAT} = yes && run_check_format "$python_files"
    test ${RUN_MYPY} = yes && run_mypy "$python_files"
    test ${RUN_PYLINT} = yes && run_pylint "$python_files"
    test ${RUN_UNIT_TESTS} = yes && run_unit_tests
    test ${RUN_DOCUMENTATION} = yes && run_documentation
    true
}

main "$@"
