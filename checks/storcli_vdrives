#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

from collections.abc import Mapping

from cmk.base.plugins.agent_based.storcli_vdrives import StorcliVDrivesSection
from cmk.base.plugins.agent_based.utils import megaraid

factory_settings["storcli_vdrives_default_levels"] = megaraid.LDISKS_DEFAULTS


def inventory_storcli_vdrives(section: StorcliVDrivesSection):
    for item in section:
        yield (item, {})


def check_storcli_vdrives(
    item: str,
    params: Mapping[str, int],
    section: StorcliVDrivesSection,
):
    if (drive := section.get(item)) is None:
        return

    yield 0, "Raid type is " + drive.raid_type
    yield 0, "Access: " + drive.access

    if not drive.consistent:
        yield 1, "Drive is not consistent"
    else:
        yield 0, "Drive is consistent"

    summary = "State is %s" % drive.state

    if (raw_state := params.get(drive.state)) is None:
        raw_state = 3
        summary += " (unknown[%s])" % drive.state

    yield raw_state, summary


check_info["storcli_vdrives"] = {
    # Section already migrated!
    "default_levels_variable": "storcli_vdrives_default_levels",
    "inventory_function": inventory_storcli_vdrives,
    "check_function": check_storcli_vdrives,
    "service_description": "RAID Virtual Drive %s",
    "group": "storcli_vdrives",
}
