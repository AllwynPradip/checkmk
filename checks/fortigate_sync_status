#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.

from cmk.base.plugins.agent_based.fortigate_sync_status import FortigateClusterSection


def discover_fortigate_sync_status(section: FortigateClusterSection):
    if section and len(section) > 1:
        yield (None, None)


def check_fortigate_sync_status(
    _no_item,
    _no_params,
    section: FortigateClusterSection,
):
    map_statuses = {"0": (2, "unsynchronized"), "1": (0, "synchronized")}
    if not section:
        return

    for cluster in section:
        if not cluster.status:
            yield (3, f"{cluster.name}: Status not available")
            return

        status, status_readable = map_statuses.get(
            cluster.status, (3, f"Unknown status {cluster.status}")
        )
        yield status, f"{cluster.name}: {status_readable}"


check_info["fortigate_sync_status"] = {
    # Section already migrated!
    "check_function": check_fortigate_sync_status,
    "inventory_function": discover_fortigate_sync_status,
    "service_description": "Sync Status",
}
