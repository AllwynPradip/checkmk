#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.
from collections.abc import Sequence
from dataclasses import dataclass

from cmk.base.api.agent_based.type_defs import StringTable
from cmk.base.plugins.agent_based.utils.threepar import parse_3par


@dataclass
class ThreeParSystem:
    name: str | None
    serial_number: str
    model: str
    system_version: str
    cluster_nodes: Sequence[int]
    online_nodes: Sequence[int]


def parse_3par_system(string_table: StringTable) -> ThreeParSystem:
    pre_parsed = parse_3par(string_table)

    return ThreeParSystem(
        name=pre_parsed.get("name"),
        serial_number=pre_parsed.get("serialNumber", "N/A"),
        model=pre_parsed.get("model", "N/A"),
        system_version=pre_parsed.get("systemVersion", "N/A"),
        cluster_nodes=pre_parsed.get("clusterNodes", []),
        online_nodes=pre_parsed.get("onlineNodes", []),
    )


def inventory_3par_system(section: ThreeParSystem):
    if section.name:
        yield (section.name, None)


def check_3par_system(
    item: str,
    _no_params,
    section: ThreeParSystem,
):

    yield 0, f"Model: {section.model}, Version: {section.system_version}, Serial number: {section.serial_number}, Online nodes: {len(section.online_nodes)}/{len(section.cluster_nodes)}"
    if len(section.online_nodes) < len(section.cluster_nodes):
        for node in set(section.cluster_nodes) ^ set(section.online_nodes):
            yield 2, f"(Node {node} not available)"


check_info["3par_system"] = {
    "parse_function": parse_3par_system,
    "inventory_function": inventory_3par_system,
    "check_function": check_3par_system,
    "service_description": "3PAR %s",
}
