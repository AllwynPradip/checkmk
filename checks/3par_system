#!/usr/bin/env python3
# Copyright (C) 2019 tribe29 GmbH - License: GNU General Public License v2
# This file is part of Checkmk (https://checkmk.com). It is subject to the terms and
# conditions defined in the file COPYING, which is part of this source code package.
from cmk.base.plugins.agent_based.threepar_system import ThreeParSystem


def inventory_3par_system(section: ThreeParSystem):
    if section.name:
        yield (section.name, None)


def check_3par_system(
    item: str,
    _no_params,
    section: ThreeParSystem,
):

    yield 0, f"Model: {section.model}, Version: {section.system_version}, Serial number: {section.serial_number}, Online nodes: {len(section.online_nodes)}/{len(section.cluster_nodes)}"
    if len(section.online_nodes) < len(section.cluster_nodes):
        for node in set(section.cluster_nodes) ^ set(section.online_nodes):
            yield 2, f"(Node {node} not available)"


check_info["3par_system"] = {
    # Section already migrated!
    "inventory_function": inventory_3par_system,
    "check_function": check_3par_system,
    "service_description": "3PAR %s",
}
